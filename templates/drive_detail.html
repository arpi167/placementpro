{% extends 'base.html' %}
{% block title %}{{ drive.company }} â€“ Drive Detail{% endblock %}
{% block extra_style %}
<style>
.pipeline-step { display:inline-flex; align-items:center; gap:0.35rem; padding:0.3rem 0.75rem; border-radius:20px; font-size:0.78rem; font-weight:700; }
.status-applied { background:#eff6ff; color:#1d4ed8; }
.status-shortlisted { background:#f0fdf4; color:#15803d; }
.status-aptitude { background:#fffbeb; color:#d97706; }
.status-interview_scheduled { background:#fef3c7; color:#d97706; }
.status-selected { background:#f0fdf4; color:#15803d; border:1px solid #86efac; }
.status-rejected { background:#fef2f2; color:#dc2626; }
.counter-box { background:white; border:1px solid var(--border); border-radius:10px; padding:0.75rem 1rem; text-align:center; }
</style>
{% endblock %}
{% block content %}
<div class="page-header">
  <a href="/tpo" style="color:var(--muted); font-size:0.85rem;">â† All Drives</a>
  <h1>{{ drive.company }} â€“ {{ drive.role }}</h1>
  <p>{{ drive.description }}</p>
</div>

<!-- TOP STATS ROW -->
<div style="display:grid; grid-template-columns:repeat(5,1fr); gap:1rem; margin-bottom:1.5rem;">
  <div class="stat-card"><div class="num">{{ drive.min_cgpa }}</div><div class="label">Min CGPA</div></div>
  <div class="stat-card"><div class="num">{{ drive.max_backlogs }}</div><div class="label">Max Backlogs</div></div>
  {% if drive.package_lpa and drive.package_lpa > 0 %}
  <div class="stat-card" style="border-top:3px solid var(--green);">
    <div class="num" style="color:var(--green);font-size:1.4rem;">â‚¹{{ drive.package_lpa }}</div>
    <div class="label">LPA Package</div>
  </div>
  {% endif %}
  <div class="stat-card"><div class="num">{{ eligible|length }}</div><div class="label">Eligible</div></div>
  <div class="stat-card" style="border-top:3px solid var(--green);">
    <div class="num" style="color:var(--green);">{{ selected_students|length }}</div>
    <div class="label">Selected</div>
  </div>
</div>

<!-- ELIGIBLE SUMMARY COUNTERS -->
<div class="card" style="margin-bottom:1.25rem; border-left:4px solid var(--blue);">
  <div style="display:flex; align-items:center; gap:1.5rem; flex-wrap:wrap;">
    <div class="counter-box" style="border-top:3px solid var(--blue);">
      <div style="font-size:1.8rem; font-weight:800; color:var(--blue); font-family:'Syne',sans-serif;">{{ eligible|length }}</div>
      <div style="font-size:0.72rem; color:var(--muted); font-weight:700;">ELIGIBLE</div>
    </div>
    <div class="counter-box" style="border-top:3px solid var(--amber);">
      <div style="font-size:1.8rem; font-weight:800; color:var(--amber); font-family:'Syne',sans-serif;">{{ applications|length }}</div>
      <div style="font-size:0.72rem; color:var(--muted); font-weight:700;">APPLIED</div>
    </div>
    <div class="counter-box" style="border-top:3px solid var(--muted);">
      <div style="font-size:1.8rem; font-weight:800; color:var(--muted); font-family:'Syne',sans-serif;">{{ eligible|length - applications|length }}</div>
      <div style="font-size:0.72rem; color:var(--muted); font-weight:700;">NOT APPLIED</div>
    </div>
    <div style="flex:1;"></div>
    {% if drive.job_type %}<span class="badge badge-blue">{{ drive.job_type }}</span>{% endif %}
    {% if drive.location %}<span style="font-size:0.85rem;color:var(--muted);">ğŸ“ {{ drive.location }}</span>{% endif %}
    <span class="badge badge-gray">Deadline: {{ drive.deadline or 'Open' }}</span>
    {% if drive.status == 'completed' %}
    <span class="badge badge-green">âœ… Completed</span>
    {% else %}
    <form method="POST" action="/tpo/drive/{{ drive.id }}/complete" onsubmit="return confirm('Mark as completed?')">
      <button class="btn btn-sm" style="background:#fef2f2;color:var(--red);border:1px solid #fca5a5;">ğŸ Mark Complete</button>
    </form>
    {% endif %}
  </div>
  {% if branch_breakdown %}
  <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
    <span style="font-size:0.78rem; font-weight:700; color:var(--muted);">Branch Breakdown:</span>
    {% for branch, count in branch_breakdown.items() %}
    <span class="badge badge-blue">{{ branch }}: {{ count }}</span>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- ACTION BUTTONS -->
<div style="display:flex; gap:0.75rem; margin-bottom:1.5rem; flex-wrap:wrap; align-items:center;">
  <form method="POST" action="/tpo/notify/{{ drive.id }}">
    <button class="btn btn-primary" type="submit">ğŸ”” Notify All Eligible ({{ eligible|length }})</button>
  </form>
</div>

<!-- NOTIFY APPLICANTS -->
<div class="card" style="margin-bottom:1.5rem; border-left:4px solid var(--amber);">
  <div class="card-title">ğŸ“£ Notify Applicants About Next Round</div>
  <form method="POST" action="/tpo/notify-applicants/{{ drive.id }}" style="display:flex; gap:0.75rem; align-items:center;">
    <input type="text" name="message" placeholder="e.g. Aptitude test on March 10 at 10 AM in Hall A. Bring ID." required
      style="flex:1; padding:0.55rem 0.9rem; border:1px solid var(--border); border-radius:8px; font-size:0.875rem;">
    <button type="submit" class="btn btn-primary">Send to {{ applications|length }} Applicants</button>
  </form>
</div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem; align-items:start;">
  <!-- ELIGIBLE STUDENTS -->
  <div class="card">
    <div class="card-title">âœ… Eligible Students ({{ eligible|length }})</div>
    {% if eligible %}
    <table>
      <thead><tr><th>Name</th><th>CGPA</th><th>Branch</th><th>Backlogs</th></tr></thead>
      <tbody>
        {% for s in eligible %}
        <tr>
          <td style="font-weight:600;">{{ s.name }}</td>
          <td><span class="badge badge-green">{{ s.cgpa }}</span></td>
          <td>{{ s.branch }}</td>
          <td>{{ s.backlogs }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p style="text-align:center;color:var(--muted);padding:1.5rem;">No eligible students yet.</p>
    {% endif %}
  </div>

  <!-- SELECTED STUDENTS -->
  <div class="card" style="border-top:3px solid var(--green);">
    <div class="card-title">ğŸ‰ Selected Students ({{ selected_students|length }})</div>
    {% if selected_students %}
    <table>
      <thead><tr><th>Name</th><th>Email</th><th>CGPA</th><th>Branch</th></tr></thead>
      <tbody>
        {% for s in selected_students %}
        <tr>
          <td style="font-weight:600;">{{ s.name }}</td>
          <td style="font-size:0.8rem;color:var(--muted);">{{ s.email }}</td>
          <td>{{ s.cgpa }}</td>
          <td>{{ s.branch }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p style="text-align:center;color:var(--muted);padding:1.5rem;">No students selected yet.</p>
    {% endif %}
  </div>
</div>

<!-- APPLICATIONS WITH PIPELINE STATUS -->
{% if applications %}
<div class="card" style="margin-bottom:1.5rem; border-top:3px solid var(--blue);">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
    <div class="card-title" style="margin-bottom:0;">ğŸ“‹ Applications â€” Round Management</div>
    <span style="font-size:0.8rem; color:var(--muted);">{{ applications|length }} applicant(s)</span>
  </div>

  <!-- Pipeline Summary Bar -->
  <div style="display:flex; gap:0; margin-bottom:1.25rem; background:var(--bg); border-radius:10px; overflow:hidden; border:1px solid var(--border);">
    {% set counts = {'applied':0,'aptitude':0,'technical':0,'hr':0,'interview_scheduled':0,'selected':0,'rejected':0} %}
    {% for a in applications %}
      {% if a.status in counts %}{% set _ = counts.update({a.status: counts[a.status]+1}) %}{% endif %}
    {% endfor %}
    {% for stage, label, color in [
      ('applied','Applied','#2563eb'),
      ('aptitude','Aptitude','#d97706'),
      ('technical','Technical','#7c3aed'),
      ('hr','HR Round','#0891b2'),
      ('selected','Selected','#16a34a'),
      ('rejected','Rejected','#dc2626')
    ] %}
    <div style="flex:1; padding:0.65rem 0.4rem; text-align:center; border-right:1px solid var(--border);">
      <div style="font-size:1.1rem; font-weight:800; color:{{ color }};">{{ counts.get(stage,0) }}</div>
      <div style="font-size:0.62rem; font-weight:700; color:var(--muted); text-transform:uppercase;">{{ label }}</div>
    </div>
    {% endfor %}
  </div>

  <table>
    <thead>
      <tr>
        <th>Student</th>
        <th>CGPA</th>
        <th>Branch</th>
        <th>Current Round</th>
        <th>Move to Round</th>
      </tr>
    </thead>
    <tbody>
      {% for a in applications %}
      <tr>
        <td>
          <div style="font-weight:600;">{{ a.name }}</div>
          <div style="font-size:0.78rem;color:var(--muted);">{{ a.email }}</div>
        </td>
        <td>{{ a.cgpa }}</td>
        <td>{{ a.branch }}</td>
        <td>
          {% if a.status == 'applied' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#eff6ff;color:#1d4ed8;">ğŸ”µ Applied</span>
          {% elif a.status == 'aptitude' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#fffbeb;color:#d97706;">ğŸ“ Aptitude</span>
          {% elif a.status == 'technical' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#f5f3ff;color:#7c3aed;">ğŸ’» Technical</span>
          {% elif a.status == 'hr' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#ecfeff;color:#0891b2;">ğŸ¤ HR Round</span>
          {% elif a.status == 'interview_scheduled' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#fef3c7;color:#d97706;">ğŸ“… Interview</span>
          {% elif a.status == 'selected' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#f0fdf4;color:#15803d;border:1px solid #86efac;">ğŸ‰ Selected</span>
          {% elif a.status == 'rejected' %}
            <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;background:#fef2f2;color:#dc2626;">âŒ Rejected</span>
          {% else %}
            <span style="display:inline-flex;padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;background:var(--bg);color:var(--muted);">{{ a.status }}</span>
          {% endif %}
        </td>
        <td>
          <form method="POST" action="/tpo/application/{{ a.id }}/status" style="display:flex;gap:0.3rem;align-items:center;flex-wrap:wrap;">
            <select name="status" style="font-size:0.8rem;padding:0.35rem 0.5rem;border:1px solid var(--border);border-radius:8px;background:white;cursor:pointer;">
              <option value="applied"              {% if a.status=='applied' %}selected{% endif %}>ğŸ”µ Applied</option>
              <option value="aptitude"             {% if a.status=='aptitude' %}selected{% endif %}>ğŸ“ Aptitude</option>
              <option value="technical"            {% if a.status=='technical' %}selected{% endif %}>ğŸ’» Technical</option>
              <option value="hr"                   {% if a.status=='hr' %}selected{% endif %}>ğŸ¤ HR Round</option>
              <option value="interview_scheduled"  {% if a.status=='interview_scheduled' %}selected{% endif %}>ğŸ“… Interview Scheduled</option>
              <option value="selected"             {% if a.status=='selected' %}selected{% endif %}>ğŸ‰ Selected</option>
              <option value="rejected"             {% if a.status=='rejected' %}selected{% endif %}>âŒ Rejected</option>
            </select>
            <button type="submit" class="btn btn-primary btn-sm" style="white-space:nowrap;">Update + Notify</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}


<!-- INTERVIEW SCHEDULER -->
<div class="card" style="margin-bottom:1.5rem; border-top:3px solid var(--amber);">
  <div class="card-title">ğŸ“… Interview Scheduler</div>

  {% if schedules %}
  <div style="margin-bottom:1.25rem;">
    <table>
      <thead><tr><th>Student</th><th>Date</th><th>Time</th><th>Room / Notes</th><th>Status</th></tr></thead>
      <tbody>
        {% for s in schedules %}
        <tr>
          <td style="font-weight:600;">{{ s.student_name }}</td>
          <td>{{ s.interview_date }}</td>
          <td>{{ s.time_slot }}</td>
          <td style="font-size:0.82rem;color:var(--muted);">{{ s.notes or 'â€”' }}</td>
          <td><span class="badge badge-amber">Scheduled</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div style="text-align:center;color:var(--muted);padding:1.5rem;">
    <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“…</div>
    No interviews scheduled yet. Use the form below to add.
  </div>
  {% endif %}

  <!-- Schedule Form -->
  <div style="background:var(--bg);border-radius:10px;padding:1rem;border:1px solid var(--border);">
    <div style="font-weight:700;font-size:0.875rem;margin-bottom:0.75rem;">+ Schedule Interview</div>
    <form method="POST" action="/tpo/drive/{{ drive.id }}/schedule">
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 2fr auto;gap:0.75rem;align-items:end;">
        <div>
          <label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:0.25rem;">Student</label>
          <select name="student_id" required style="width:100%;padding:0.5rem;border:1px solid var(--border);border-radius:8px;font-size:0.875rem;">
            <option value="">Select student</option>
            {% for s in all_students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:0.25rem;">Date</label>
          <input type="date" name="interview_date" required style="width:100%;padding:0.5rem;border:1px solid var(--border);border-radius:8px;font-size:0.875rem;">
        </div>
        <div>
          <label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:0.25rem;">Time</label>
          <input type="time" name="time_slot" required style="width:100%;padding:0.5rem;border:1px solid var(--border);border-radius:8px;font-size:0.875rem;">
        </div>
        <div>
          <label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:0.25rem;">Room / Notes</label>
          <input type="text" name="notes" placeholder="e.g. Room 204, Hall B" style="width:100%;padding:0.5rem;border:1px solid var(--border);border-radius:8px;font-size:0.875rem;">
        </div>
        <button type="submit" class="btn btn-primary">Schedule</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
